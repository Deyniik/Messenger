<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deynik Messenger - Online Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #1DB954;
            margin-bottom: 20px;
        }
        
        .auth-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .user-profile {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .users-list {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
        }
        
        .user-item {
            padding: 10px;
            margin: 5px 0;
            background: #333;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1DB954;
        }
        
        .offline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-text {
            font-size: 12px;
            color: #888;
        }
        
        .logout-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ Deynik Messenger - Online Test</h1>
        
        <div class="auth-section" id="auth-section">
            <button class="login-btn" id="loginBtn">
                üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
            </button>
        </div>
        
        <div class="users-list">
            <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω:</h3>
            <div id="usersList">
                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBk4nxZ1ldNQUCxsbgaeYTkm9stq0o9o2Q",
            authDomain: "deygram-e4814.firebaseapp.com",
            projectId: "deygram-e4814",
            storageBucket: "deygram-e4814.firebasestorage.app",
            messagingSenderId: "591207353726",
            appId: "1:591207353726:web:d20f5e648d3daf86fcb72f"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let onlineCheckInterval;
        let usersListener;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        function startOnlinePing() {
            if (onlineCheckInterval) clearInterval(onlineCheckInterval);
            
            onlineCheckInterval = setInterval(() => {
                if (currentUser) {
                    db.collection('onlineUsers').doc(currentUser.uid).set({
                        uid: currentUser.uid,
                        displayName: currentUser.displayName || '–ê–Ω–æ–Ω–∏–º',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        online: true
                    });
                }
            }, 3000);
        }

        // –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function startCleanup() {
            setInterval(() => {
                const cutoff = new Date(Date.now() - 10000); // 10 —Å–µ–∫—É–Ω–¥
                db.collection('onlineUsers')
                    .where('lastSeen', '<', cutoff)
                    .get()
                    .then(snapshot => {
                        snapshot.forEach(doc => {
                            doc.ref.delete(); // –£–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
                        });
                    });
            }, 5000);
        }

        // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function listenToOnlineUsers() {
            if (usersListener) usersListener(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è
            
            usersListener = db.collection('onlineUsers')
                .onSnapshot(snapshot => {
                    const usersList = document.getElementById('usersList');
                    usersList.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        if (user.uid !== currentUser.uid) {
                            const userElement = document.createElement('div');
                            userElement.className = 'user-item';
                            userElement.innerHTML = `
                                <div>${user.displayName}</div>
                                <div class="online-status">
                                    <div class="online-dot"></div>
                                    <span>online</span>
                                </div>
                            `;
                            usersList.appendChild(userElement);
                        }
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω
                    const onlineCount = snapshot.size - (currentUser ? 1 : 0);
                    if (onlineCount === 0) {
                        usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</div>';
                    }
                });
        }

        // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    currentUser = result.user;
                    updateUI();
                    startOnlinePing();
                    listenToOnlineUsers();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                });
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            if (currentUser) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                db.collection('onlineUsers').doc(currentUser.uid).delete();
            }
            
            if (onlineCheckInterval) clearInterval(onlineCheckInterval);
            if (usersListener) usersListener();
            
            auth.signOut();
            currentUser = null;
            updateUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            const authSection = document.getElementById('auth-section');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <div class="user-profile">
                        <h3>üëã –ü—Ä–∏–≤–µ—Ç, ${currentUser.displayName}!</h3>
                        <p>–¢–≤–æ–π —Å—Ç–∞—Ç—É—Å: <span style="color: #1DB954;">‚óè –æ–Ω–ª–∞–π–Ω</span></p>
                        <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                    </div>
                `;
            } else {
                authSection.innerHTML = `
                    <button class="login-btn" id="loginBtn">
                        üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                    </button>
                `;
                document.getElementById('loginBtn').onclick = login;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                navigator.sendBeacon = navigator.sendBeacon || function() { return false; };
                
                // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–Ω–ª–∞–π–Ω
                const url = `https://firestore.googleapis.com/v1/projects/deygram-e4814/databases/(default)/documents/onlineUsers/${currentUser.uid}`;
                const blob = new Blob([], { type: 'application/json' });
                navigator.sendBeacon(url, blob);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUI();
            
            if (user) {
                startOnlinePing();
                startCleanup();
                listenToOnlineUsers();
            } else {
                if (onlineCheckInterval) clearInterval(onlineCheckInterval);
                if (usersListener) usersListener();
                document.getElementById('usersList').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            }
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        startCleanup();
    </script>
</body>
</html>
