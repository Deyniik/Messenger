<!DOCTYPE html>
<html>
<head>
    <title>Deynik Messenger</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 20px; background: #121212; color: white; font-family: Arial; }
        .btn { background: #1DB954; color: white; border: none; padding: 10px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .users { background: #191414; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .user { padding: 10px; margin: 5px 0; background: #333; border-radius: 5px; cursor: pointer; }
        .chat { background: #191414; padding: 15px; margin: 10px 0; border-radius: 8px; height: 300px; overflow-y: auto; }
        .msg { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .own { background: #1DB954; margin-left: 50px; }
        .other { background: #333; margin-right: 50px; }
        .input { display: flex; margin-top: 10px; }
        .input input { flex: 1; padding: 10px; border-radius: 5px; border: none; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>üí¨ Deynik Messenger</h1>
    
    <div id="auth">
        <button class="btn" onclick="login()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>

    <div id="app" style="display:none">
        <div class="users">
            <h3>üë• –û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></h3>
            <div id="usersList"></div>
        </div>

        <div class="chat" id="chat"></div>

        <div class="input">
            <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
            <button class="btn" id="sendBtn" disabled onclick="sendMsg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <button class="btn" onclick="logout()" style="background:#666">–í—ã–π—Ç–∏</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBk4nxZ1ldNQUCxsbgaeYTkm9stq0o9o2Q",
            authDomain: "deygram-e4814.firebaseapp.com",
            projectId: "deygram-e4814",
            storageBucket: "deygram-e4814.firebasestorage.app",
            messagingSenderId: "591207353726",
            appId: "1:591207353726:web:d20f5e648d3daf86fcb72f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let selectedUser = null;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
                db.collection('messengerUsers').doc(user.uid).set({
                    uid: user.uid,
                    displayName: user.displayName,
                    online: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                loadUsers();
                
                // –ü–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                setInterval(() => {
                    if (currentUser) {
                        db.collection('messengerUsers').doc(currentUser.uid).update({
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            online: true
                        });
                    }
                }, 5000);
                
                // –û—á–∏—Å—Ç–∫–∞ –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                setInterval(cleanupOfflineUsers, 10000);
                
            } else {
                currentUser = null;
                document.getElementById('auth').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }
        });

        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        }

        function logout() {
            if (currentUser) {
                db.collection('messengerUsers').doc(currentUser.uid).update({
                    online: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            auth.signOut();
        }

        // –û—á–∏—Å—Ç–∫–∞ –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function cleanupOfflineUsers() {
            if (!currentUser) return;
            
            const offlineTime = new Date(Date.now() - 15000); // 15 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
            
            db.collection('messengerUsers')
                .where('online', '==', true)
                .where('lastSeen', '<', offlineTime)
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        db.collection('messengerUsers').doc(doc.id).update({
                            online: false
                        });
                    });
                });
        }

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        function loadUsers() {
            db.collection('messengerUsers')
                .where('online', '==', true)
                .onSnapshot(snapshot => {
                    const usersList = document.getElementById('usersList');
                    const onlineCount = document.getElementById('onlineCount');
                    let count = 0;
                    
                    usersList.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        if (user.uid !== currentUser.uid) {
                            count++;
                            const userDiv = document.createElement('div');
                            userDiv.className = 'user';
                            userDiv.textContent = user.displayName;
                            userDiv.onclick = () => selectUser(user);
                            usersList.appendChild(userDiv);
                        }
                    });
                    
                    onlineCount.textContent = count;
                    
                    if (count === 0) {
                        usersList.innerHTML = '<div style="color:#666; text-align:center">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</div>';
                    }
                });
        }

        function selectUser(user) {
            selectedUser = user;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('msgInput').placeholder = `–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ${user.displayName}...`;
            loadMessages();
        }

        // –°–æ–æ–±—â–µ–Ω–∏—è
        function loadMessages() {
            if (!selectedUser) return;
            
            const chatId = [currentUser.uid, selectedUser.uid].sort().join('_');
            const chat = document.getElementById('chat');
            
            db.collection('privateMessages')
                .where('chatId', '==', chatId)
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    chat.innerHTML = '';
                    
                    if (snapshot.empty) {
                        chat.innerHTML = '<div style="color:#666; text-align:center">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const msgDiv = document.createElement('div');
                        msgDiv.className = `msg ${msg.senderId === currentUser.uid ? 'own' : 'other'}`;
                        msgDiv.innerHTML = `<strong>${msg.senderName}:</strong> ${msg.text}`;
                        chat.appendChild(msgDiv);
                    });
                    
                    chat.scrollTop = chat.scrollHeight;
                });
        }

        function sendMsg() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            
            if (!text || !selectedUser) return;
            
            const chatId = [currentUser.uid, selectedUser.uid].sort().join('_');
            
            db.collection('privateMessages').add({
                chatId: chatId,
                senderId: currentUser.uid,
                senderName: currentUser.displayName,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            input.value = '';
        }

        document.getElementById('msgInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMsg();
        });

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞–≤–∏–º –æ—Ñ—Ñ–ª–∞–π–Ω
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                db.collection('messengerUsers').doc(currentUser.uid).update({
                    online: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
    </script>
</body>
</html>
