// –ó–ê–ú–ï–ù–ò —Ñ—É–Ω–∫—Ü–∏—é loadUsers() –Ω–∞ —ç—Ç—É:

function loadUsers() {
    if (usersUnsubscribe) usersUnsubscribe();
    
    console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
    
    usersUnsubscribe = db.collection('messengerUsers')
        .where('online', '==', true)
        .onSnapshot((snapshot) => {
            users = [];
            usersList.innerHTML = '';
            
            console.log('üìä –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ:', snapshot.size);
            
            let onlineCountValue = 0;
            
            snapshot.forEach((doc) => {
                const user = doc.data();
                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –±–∞–∑—ã:', user.displayName, 'UID:', user.uid, '–û–Ω–ª–∞–π–Ω:', user.online);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (user.uid !== currentUser.uid) {
                    users.push(user);
                    addUserToList(user);
                    onlineCountValue++;
                    console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫:', user.displayName);
                } else {
                    console.log('‚ùå –≠—Ç–æ —è —Å–∞–º, –ø—Ä–æ–ø—É—Å–∫–∞—é:', user.displayName);
                }
            });
            
            onlineCount.textContent = onlineCountValue;
            console.log('üéØ –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω:', onlineCountValue);
            
            if (onlineCountValue === 0) {
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</p>
                        <p style="font-size: 0.8rem; margin-top: 10px; color: #1DB954;">
                            –û—Ç–∫—Ä–æ–π—Ç–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –≤ –¥—Ä—É–≥–æ–º –±—Ä–∞—É–∑–µ—Ä–µ/–≤–∫–ª–∞–¥–∫–µ –∏ –≤–æ–π–¥–∏—Ç–µ –ø–æ–¥ –¥—Ä—É–≥–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º
                        </p>
                    </div>
                `;
            }
        }, (error) => {
            console.error('üí• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            usersList.innerHTML = `
                <div style="text-align: center; padding: 20px; color: red;">
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    <p style="font-size: 0.8rem;">${error.message}</p>
                </div>
            `;
        });
}

// –ò –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é –≤—Ö–æ–¥–∞:

function handleUserSignedIn(user) {
    console.log('üîë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', user.displayName, user.uid);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    loginBtn.style.display = 'none';
    userProfile.style.display = 'flex';
    
    const displayName = user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    const firstLetter = displayName.charAt(0).toUpperCase();
    
    userName.textContent = displayName;
    userAvatar.textContent = firstLetter;
    
    // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –í –ë–ê–ó–ï –ü–ï–†–ï–î –ó–ê–ì–†–£–ó–ö–û–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
    db.collection('messengerUsers').doc(user.uid).set({
        uid: user.uid,
        displayName: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        online: true
    }, { merge: true })
    .then(() => {
        console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è:', user.displayName);
        // –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –≠–¢–û–ì–û –≥—Ä—É–∑–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        loadUsers();
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${displayName}!`);
}

// –ò –¥–æ–±–∞–≤—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞:

function startOnlinePing() {
    // –ü–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        if (currentUser) {
            db.collection('messengerUsers').doc(currentUser.uid).update({
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                online: true
            })
            .then(() => console.log('üü¢ –ü–∏–Ω–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'))
            .catch(error => console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∏–Ω–≥–∞:', error));
        }
    }, 20000);
}

// –í—ã–∑–æ–≤–∏ startOnlinePing() –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞:

function handleUserSignedIn(user) {
    console.log('üîë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', user.displayName, user.uid);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    loginBtn.style.display = 'none';
    userProfile.style.display = 'flex';
    
    const displayName = user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    const firstLetter = displayName.charAt(0).toUpperCase();
    
    userName.textContent = displayName;
    userAvatar.textContent = firstLetter;
    
    // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –í –ë–ê–ó–ï
    db.collection('messengerUsers').doc(user.uid).set({
        uid: user.uid,
        displayName: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        online: true
    }, { merge: true })
    .then(() => {
        console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è:', user.displayName);
        loadUsers();
        startOnlinePing(); // –ó–ê–ü–£–°–ö–ê–ï–ú –ü–ò–ù–ì
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
    });
    
    showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${displayName}!`);
}
